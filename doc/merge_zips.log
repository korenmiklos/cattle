--------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/koren/Dropbox/projects/submitted/balassa/code/../doc/merge_zips.log
  log type:  text
 opened on:  14 Feb 2019, 14:51:18

. 
. * read zip-level population
. tempfile zippop

. insheet using ../data/census/cbp/zcta_county_rel_10.txt
(24 vars, 44,410 obs)

. collapse (mean) zpop zhu zarealand, by(zcta5)

. ren zcta5 zip

. replace zarealand = zarealand/1e+6
(33,120 real changes made)

. ren zarealand ziparea

. ren zpop pop

. ren zhu homes

. sort zip 

. save `zippop', replace
(note: file /var/folders/f4/7drmhl1d5kj3wp1r33jvx32m0000gn/T//S_00459.000001 not found)
file /var/folders/f4/7drmhl1d5kj3wp1r33jvx32m0000gn/T//S_00459.000001 saved

. 
. clear

. insheet using ../data/census/cbp/zbp07detail.txt
(12 vars, 3,340,643 obs)

. 
. * drop sector totals, no new info
. drop if naics=="------"
(39,652 observations deleted)

. 
. * keep only 2-digit NAICS
. keep if substr(naics,3,4)=="----"
(2,874,166 observations deleted)

. 
. * estimate employment
. gen emp = n1_4*2.5 + n5_9*7 + n10_19*15 + n20_49*35 + n50_99*75 + n100_249*175 + n250_499*375 + n500_9
> 99*750 + n1000*2000

. 
. gen sector = real(substr(naics,1,2))

. drop n*

. 
. * fill in all sectors
. reshape wide est emp, i(zip) j(sector)
(note: j = 11 21 22 23 31 42 44 48 51 52 53 54 55 56 61 62 71 72 81 99)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                   426825   ->   39652
Number of variables                   4   ->      41
j variable (20 values)           sector   ->   (dropped)
xij variables:
                                    est   ->   est11 est21 ... est99
                                    emp   ->   emp11 emp21 ... emp99
-----------------------------------------------------------------------------

. reshape long
(note: j = 11 21 22 23 31 42 44 48 51 52 53 54 55 56 61 62 71 72 81 99)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                    39652   ->  793040
Number of variables                  41   ->       4
j variable (20 values)                    ->   sector
xij variables:
                  est11 est21 ... est99   ->   est
                  emp11 emp21 ... emp99   ->   emp
-----------------------------------------------------------------------------

. replace est=0 if missing(est)
(366,215 real changes made)

. replace emp=0 if missing(emp)
(366,215 real changes made)

. 
. * merge different sectors
. recode sector 11 21 22 = 1 23 31 = 2 * =3
(sector: 793040 changes made)

. * keep only urban sectors: construction, manufacturing, services
. keep if sector==2 | sector==3
(118,956 observations deleted)

. collapse (sum) emp est, by(zip)

. 
. * merge distances and areas
. csvmerge zip using ../data/census/cbp/zip.csv
(8 vars, 33,120 obs)
(note: file /var/folders/f4/7drmhl1d5kj3wp1r33jvx32m0000gn/T//S_00459.000002 not found)
file /var/folders/f4/7drmhl1d5kj3wp1r33jvx32m0000gn/T//S_00459.000002 saved
(note: you are using old merge syntax; see [D] merge for new syntax)

. tab _m

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      7,148       17.75       17.75
          2 |        616        1.53       19.28
          3 |     32,504       80.72      100.00
------------+-----------------------------------
      Total |     40,268      100.00

. tab _m [fw=est]

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    114,766        1.50        1.50
          3 |  7,523,731       98.50      100.00
------------+-----------------------------------
      Total |  7,638,497      100.00

. * nonmatched zips are only 1.54% of establishments, drop them
. 
. keep if _m==3
(7,764 observations deleted)

. drop _m

. 
. * use distance to urban area, not MSA
. ren citydistance distance

. ren city city
  (all newnames==oldnames)

. 
. * area is in m2, convert to km2
. replace area = area/1e+6
(32,504 real changes made)

. 
. * merge population data
. merge m:1 zip using `zippop', keep(match)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                            32,504  (_merge==3)
    -----------------------------------------

. drop _m

. 
. corr area ziparea
(obs=32,504)

             |     area  ziparea
-------------+------------------
        area |   1.0000
     ziparea |   1.0000   1.0000


. 
. 
. * merge naics land and labor shares
. gen laborshare = 0.67

. gen landshare = 0.05

. 
. * calculate densities
. gen emp_density = emp/area

. gen est_density = est/area

. gen lndistance = ln(distance)

. label var lndistance "Distance to city center (log)"

. 
. * split up area between activities
. egen people = sum(emp), by(zip)

. egen landdemand = sum(emp/laborshare*landshare), by(zip)

. * people living or working in this zip code all take up space
. * population has land share 0.3*0.36
. replace landdemand = landdemand+pop*0.3*0.36
(32,368 real changes made)

. 
. * allocate area of ZIP to sectors based on their direct need 
. gen share = emp/laborshare*landshare/landdemand

. su share, d

                            share
-------------------------------------------------------------
      Percentiles      Smallest
 1%     .0057925              0
 5%      .016654              0
10%     .0267626              0       Obs              32,504
25%     .0553657              0       Sum of Wgt.      32,504

50%     .1139519                      Mean            .157623
                        Largest       Std. Dev.      .1551269
75%     .2076763              1
90%     .3252393              1       Variance       .0240644
95%     .4425952              1       Skewness       2.451847
99%     .8564159              1       Kurtosis       11.15588

. reg share lndistance

      Source |       SS           df       MS      Number of obs   =    32,504
-------------+----------------------------------   F(1, 32502)     =   5034.02
       Model |  104.897312         1  104.897312   Prob > F        =    0.0000
    Residual |  677.266531    32,502  .020837688   R-squared       =    0.1341
-------------+----------------------------------   Adj R-squared   =    0.1341
       Total |  782.163844    32,503  .024064358   Root MSE        =    .14435

------------------------------------------------------------------------------
       share |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
  lndistance |  -.0551923   .0007779   -70.95   0.000     -.056717   -.0536676
       _cons |   .3540615   .0028821   122.85   0.000     .3484124    .3597105
------------------------------------------------------------------------------

. 
. 
. * area of zip is split across sectors and homeowners
. gen imputed_area = share*area

. gen residential_area = pop*0.3*0.36/landdemand*area

. 
. gen establishment_size = emp/est
(74 missing values generated)

. gen imputed_density = emp/imputed_area
(74 missing values generated)

. 
. saveold ../data/zip_business_patterns, replace
(saving in Stata 13 format)
(FYI, saveold has options version(12) and version(11) that write files in older Stata formats)
file ../data/zip_business_patterns.dta saved

. 
. 
. log close
      name:  <unnamed>
       log:  /Users/koren/Dropbox/projects/submitted/balassa/code/../doc/merge_zips.log
  log type:  text
 closed on:  14 Feb 2019, 14:51:33
--------------------------------------------------------------------------------------------------------
